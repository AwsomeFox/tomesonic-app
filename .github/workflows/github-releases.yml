name: Create GitHub Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Install dependencies
        run: npm ci

      - name: Build Nuxt project
        run: npm run generate

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build debug APK
        run: ./android/gradlew assembleDebug -p android --no-daemon

      - name: Rename APK
        working-directory: android/app/build/outputs/apk/debug/
        run: |
          version="${GITHUB_REF#refs/tags/}"
          mv app-debug.apk "tomesonic-${version}.apk"

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Extract version from tag
          VERSION="${GITHUB_REF#refs/tags/}"
          
          # Create release notes
          cat > release_notes.md << 'EOF'
          ## ðŸŽ‰ TomeSonic ${VERSION}
          
          ### ðŸ“± Download
          - **Android**: Download the APK below and install on your device
          - **Play Store**: Available on [Google Play Store](https://play.google.com/store/apps/details?id=com.tomesonic.app)
          
          ### âœ¨ What's New
          <!-- Add release highlights here or extract from CHANGELOG -->
          - Bug fixes and performance improvements
          - Latest features and enhancements
          
          ### ðŸ”§ Technical Details
          - Built from commit: ${GITHUB_SHA:0:7}
          - Build date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ### ðŸ“– Full Documentation
          See the [README](https://github.com/AwsomeFox/tomesonic-app#readme) for setup instructions and features.
          EOF
          
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "TomeSonic ${{ steps.release_notes.outputs.VERSION }}"
          body_path: release_notes.md
          files: |
            android/app/build/outputs/apk/debug/tomesonic-*.apk
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest release info
        run: |
          echo "âœ… Release ${{ steps.release_notes.outputs.VERSION }} created successfully!"
          echo "ðŸ“± APK available for download in the release"
          echo "ðŸš€ Play Store deployment will trigger automatically"